#!/bin/bash

. mutil.sh

adb=0

eval "$(getopt.pl -Nx '
a|adb adb=1 # Complete with android device files.
' "$@")"

token="$(sh-get-current-token -f)"

env_expansion=0
shescapes=shescapes

if [[ "$token" = \$* ]] ; then
  env_expansion=1
  shescapes=cat
fi

gitroot="$(git rev-parse --show-toplevel 2>/dev/null)"

maybe_escape() {
  word="$(cat)"
  if [[ "$word" =~ ^\$ ]] ; then
    echo "$word"
  else
    shescape "$word"
  fi
}

completed=$(
    {
      if (( $env_expansion )) ; then
        # Env names.
        env | sed -e 's!^![ENV] $!; s!=.*!!'

      else
        cat <(
          if in-git ; then
            # Git branches
            git branch | sed -n '/^..(/d; s/^. /[GIT-BRANCH] /p;'
          fi
        )

        (
          if [[ "$ANDROID_BUILD_TOP" ]] ; then
            cat <<'EOF'
$ANDROID_BUILD_TOP/build/soong/
$ANDROID_BUILD_TOP/cts/
$ANDROID_BUILD_TOP/frameworks/base/
$ANDROID_BUILD_TOP/out/
$ANDROID_BUILD_TOP/out/soong/.intermediates/
$ANDROID_HOST_OUT/
EOF
          fi
          env | sed -e 's/=.*//'
        ) | global-unique | sed -e 's/^/[ENV] $/'

        # Recent directories
        timeout 1 cat <(
          recent-dirs -n 50 -z | perl -ne 'chomp; print "[RECENT-DIR] ", $_, "/\n"'
        )

        # Filenames in recent logs
        timeout 0.5 cat <(
          zenlog-recent-files -d | global-unique | head -100 | dir-slash | sed 's/^/[RECENT-FILE] /'
        )

        # Recent words in zenlog
        timeout 0.5 cat <(
          zenlog-last-n-contents -R -n 5 | zenlog-recent-words.pl | global-unique | head -1000 | perl -pe 'print "[RECENT-WORD] "'
        )
      fi
    } 2>/dev/null |
    nobuf tr -s / /|
    nobuf tee /tmp/fzf-in.txt |
    fzf -q "$token" -m --preview='preview-file {2..}' |
      perl -pe 's!^\S+\s*!!; s!^.*\{\{\s*(.*?)\s*\}\}.*$!\1!' |
      maybe_escape |
      add-backslash-except-for-last
)

if [[ -n "$completed" ]] ; then
  sh-replace-current-token "$completed"
fi
