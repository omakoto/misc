#!/bin/bash

. mutil.sh

adb=0

eval "$(getopt.pl -Nx '
a|adb adb=1 # Complete with android device files.
' "$@")"

token="$(readline-current-token -f)"

env_expansion=0
shescapes=shescapes

if [[ "$token" = \$* ]] ; then
  env_expansion=1
  shescapes=cat
fi


completed=$(
    {
      if (( $env_expansion )) ; then
        # Env names.
        env | sed -e 's!^![ENV] $!; s!=.*!!'

      else
        # Git branches
        git branch | sed -n '/^..(/d; s/^. /[GIT-BRANCH] /p;'

        # Git changed files
        rp -q | sed $'s/^A[ \t]*/[GIT-CHANGED-ADDED] /; s/^D[ \t]*/[GIT-CHANGED-DELETED] /; s/^M[ \t]*/[GIT-CHANGED-MODIFIED] /'

        # Filenames in recent logs
        zenlog-recent-files -d | dir-slash | sed 's/^/[RECENT-FILE] /'

        # Recent words in zenlog
        zenlog-last-n-contents -R -n 10 | zenlog-recent-words.pl | global-unique | sed -e 's/^/[RECENT-WORD] /'

        # Android modules
        android-module-list -q | sed 's/^/[ANDROID-MODULE] /'

        # Android device files
        bash-fzf-complete-current-token-android-helper "${token}"

        # Git tags
        git tag | sed -e 's/^/[GIT-TAG] /'

        # Recent directories
        recent-dirs | sed 's/^/[RECENT-DIR] /; s!$!/!'

        # Executable files.
        list-commands-in-path | sed 's/^/[EXE] /'

        # Local files files
        for tok in "$token"*; do
          if [[ -f "$tok" ]] ; then
            echo "$tok"
          else
            find "$tok"
          fi
        done | dir-slash | sed 's/^/[LOCAL-FILE] /'
      fi
    } 2>/dev/null |
    fzf -q "$token" -m --preview='preview-file {}' | cut -d ' ' -f 2- | $shescapes |  tr '\n' ' '
    )

if [[ -n "$completed" ]] ; then
  readline-replace "$completed"
fi
