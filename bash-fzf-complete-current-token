#!/bin/bash

. mutil.sh

adb=0

eval "$(getopt.pl -Nx '
a|adb adb=1 # Complete with android device files.
' "$@")"

token="$(readline-current-token -f)"

env_expansion=0
shescapes=shescapes

if [[ "$token" = \$* ]] ; then
  env_expansion=1
  shescapes=cat
fi


completed=$(
    {
      if (( $env_expansion )) ; then
        # Env names.
        env | sed -e 's!^!$!; s!=.*!!'

      else
        Android device files
        bash-fzf-complete-current-token-android-helper "${token}"

        # Android modules
        android-module-list -q

        # Filenames in recent logs
        zenlog-recent-files -d | dir-slash

        # Executable files.
        list-commands-in-path

        # Local files files
        for tok in "$token"*; do
          if [[ -f "$tok" ]] ; then
            echo "$tok"
          else
            find "$tok"
          fi
        done | dir-slash
      fi
    } 2>/dev/null |
    fzf -q "$token" -m --preview='preview-file {}' | $shescapes |  tr '\n' ' '
    )

if [[ -n "$completed" ]] ; then
  readline-replace "$completed"
fi
